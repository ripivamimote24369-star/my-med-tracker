<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>精密服药记录系统 V12</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="精密服药">

    <style>
        :root {
            --font-main: "Times New Roman", "SimSun", "BaseSimSun", "宋体", serif;
            --bg: #f4f6f8; --card: #ffffff; --accent: #27ae60; 
            --warning: #e74c3c; --anchor: #f39c12; --text-main: #2c3e50; --border: #dcdde1;
        }

        body {
            font-family: var(--font-main); background-color: var(--bg); color: var(--text-main);
            margin: 0; padding: env(safe-area-inset-top) 15px 30px 15px;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; touch-action: pan-y; /* 锁定垂直滚动，允许脚本拦截水平手势 */
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 550px; width: 100%; }

        .header {
            background: var(--card); padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px;
            position: sticky; top: env(safe-area-inset-top); z-index: 100; border: 1px solid var(--border);
        }
        .v-tag { font-size: 10px; color: #ccc; float: right; border: 1px solid #eee; padding: 1px 4px; border-radius: 3px; }
        .clock-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 8px; margin-bottom: 8px; }
        #clock { font-size: 1.8em; font-weight: bold; font-family: "Times New Roman", serif; }
        #progress-stats { color: var(--accent); font-weight: bold; font-size: 0.9em; }
        
        .date-row { display: flex; align-items: center; justify-content: space-between; gap: 5px; font-size: 0.9em; }
        input[type="date"] { font-family: var(--font-main); border: 1px solid var(--border); padding: 6px; border-radius: 4px; font-size: 1em; background: #fff; }
        .btn-today { background: var(--accent); color: white; border: none; padding: 7px 12px; border-radius: 4px; font-size: 0.8em; }

        .task-card { background: var(--card); border-radius: 10px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border); }
        .task-card.active { border: 2px solid var(--accent); box-shadow: 0 0 12px rgba(39, 174, 96, 0.1); }
        .task-card.missed { border-left: 6px solid var(--warning); }
        .task-card.future { opacity: 0.6; }

        .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-bottom: 8px; background: #eee; color: #666; }
        .fixed-badge { background: var(--anchor); color: white; }

        .item-row { display: flex; align-items: flex-start; gap: 12px; margin-top: 8px; }
        input[type="checkbox"] { width: 28px; height: 28px; cursor: pointer; accent-color: var(--accent); flex-shrink: 0; }
        
        .med-info { flex: 1; }
        .med-title { font-weight: bold; font-size: 1.1em; }
        .med-dose { color: #d35400; font-family: "Times New Roman", serif; font-size: 1.1em; font-weight: bold; }
        .med-logic { font-size: 0.85em; color: #7f8c8d; margin-top: 4px; border-top: 1px dashed #eee; padding-top: 4px; }

        .notes-section { background: #fffdf0; border: 1px solid #ffe58f; padding: 15px; border-radius: 10px; margin-top: 20px; }
        textarea { width: 100%; height: 100px; border: none; background: transparent; font-family: var(--font-main); font-size: 1.1em; outline: none; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button.primary { padding: 12px; border: none; border-radius: 8px; font-family: var(--font-main); font-weight: bold; background: var(--text-main); color: white; }
        button.reset { padding: 12px; border: 1px solid #fcc; border-radius: 8px; background: #fee; color: var(--warning); font-family: var(--font-main); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <span class="v-tag">CODE V12.0</span>
        <div class="clock-row">
            <div id="clock">00:00:00</div>
            <div id="progress-stats">0 / 13</div>
        </div>
        <div class="date-row">
            <input type="date" id="date-picker" onchange="renderList()">
            <button class="btn-today" onclick="goToday()">回到今天</button>
        </div>
    </div>
    <div id="task-list"></div>
    <div class="notes-section">
        <h3>当日体感观察笔记</h3>
        <textarea id="note-input" placeholder="输入记录..." oninput="saveNote()"></textarea>
    </div>
    <div class="actions">
        <button class="primary" onclick="exportJSON()">备份全数据</button>
        <button class="reset" onclick="resetDay()">重置记录</button>
    </div>
</div>

<script>
// 逐字核校原始数据
const schedule = [
    { t: "07:00", label: "晨起", items: [{ n: "自制生姜水", d: "2-3片老生姜泡水", l: "暖脾胃，为止泻打底" }] },
    { t: "07:30", label: "早餐前", items: [{ n: "参苓白术散", d: "1/2袋 (6g)", l: "饭前30min，封堵肠道漏洞" }] },
    { t: "08:30", label: "早餐后", items: [
        { n: "生脉饮 + 锌片", d: "1支 + 1/2片 (25mg)", l: "锌片切半，防止刺激肠道" },
        { n: "精氨酸瓜氨酸", d: "1粒", l: "提供 NO 燃料" }
    ]},
    { t: "11:30", label: "午餐前", items: [{ n: "参苓白术散", d: "1/2袋 (6g)", l: "稳固中焦" }] },
    { t: "12:30", label: "午餐后", items: [{ n: "知柏地黄丸", d: "4丸", l: "针对舌尖红。便稀则停药" }] },
    { t: "16:00", label: "核心修复", fixed: true, items: [{ n: "他达拉非", d: "5mg (1片)", l: "避开排便高峰，核心修复" }] },
    { t: "17:30", label: "晚餐前", items: [{ n: "参苓白术散", d: "1/2袋 (6g)", l: "保证晚餐后的吸收环境" }] },
    { t: "18:30", label: "晚餐后", items: [
        { n: "维生素 D3", d: "2000 IU (1粒)", l: "随餐吸收最好" },
        { n: "精氨酸瓜氨酸", d: "1粒", l: "配合核心药进行夜间修复" },
        { n: "知柏地黄丸", d: "4丸", l: "压制夜间虚火" }
    ]},
    { t: "22:00", label: "睡前", items: [{ n: "甘氨酸镁 + 生脉饮", d: "1粒 + 1支", l: "神经放松，辅助深睡眠" }] },
    { t: "23:00", label: "临界点", fixed: true, items: [{ n: "强制入睡", d: "唯一真理" }] }
];

const picker = document.getElementById('date-picker');
const getTodayStr = () => new Date().toLocaleDateString('en-CA'); 
let physicalDay = getTodayStr(); 
picker.value = physicalDay;

function tick() {
    const now = new Date();
    document.getElementById('clock').innerText = now.toTimeString().split(' ')[0];
    const currentRealDay = getTodayStr();
    if (physicalDay !== currentRealDay) {
        physicalDay = currentRealDay;
        picker.value = currentRealDay;
        renderList();
    }
    if (window.lastMin !== now.getMinutes()) {
        renderList();
        window.lastMin = now.getMinutes();
    }
}

function renderList() {
    const now = new Date();
    const curTime = now.getHours() * 60 + now.getMinutes();
    const selectedDate = picker.value;
    const isViewingToday = selectedDate === getTodayStr();
    const db = JSON.parse(localStorage.getItem('med_v10_db') || '{}');
    const dayData = db[selectedDate] || { checks: {}, note: "" };

    let html = '', checkedCount = 0, totalCount = 0;
    schedule.forEach((slot, sIdx) => {
        const [sh, sm] = slot.t.split(':').map(Number);
        const slotMin = sh * 60 + sm;
        let status = '';
        if (isViewingToday) {
            if (curTime >= slotMin && curTime < slotMin + 60) status = 'active';
            else if (curTime >= slotMin + 60 && !isSlotDone(dayData.checks, sIdx)) status = 'missed';
            else if (curTime < slotMin) status = 'future';
        }

        html += `<div class="task-card ${status} ${slot.fixed ? 'fixed' : ''}">
            <div class="badge ${slot.fixed ? 'fixed-badge' : ''}">${slot.t} ${slot.label}</div>`;
        slot.items.forEach((item, iIdx) => {
            totalCount++;
            const key = `${sIdx}-${iIdx}`;
            if (dayData.checks[key]) checkedCount++;
            html += `<div class="item-row">
                <input type="checkbox" ${dayData.checks[key]?'checked':''} onchange="toggle('${selectedDate}','${key}',this.checked)">
                <div class="med-info">
                    <div class="med-title">${item.n} <span class="med-dose">${item.d}</span></div>
                    <div class="med-logic">${item.l || ''}</div>
                </div>
            </div>`;
        });
        html += `</div>`;
    });
    document.getElementById('task-list').innerHTML = html;
    document.getElementById('progress-stats').innerText = `${selectedDate} 进度: ${checkedCount} / ${totalCount}`;
    document.getElementById('note-input').value = dayData.note || "";
}

function isSlotDone(checks, sIdx) { return schedule[sIdx].items.every((_, iIdx) => checks[`${sIdx}-${iIdx}`]); }

function toggle(date, key, val) {
    let db = JSON.parse(localStorage.getItem('med_v10_db') || '{}');
    if (!db[date]) db[date] = { checks: {}, note: "" };
    db[date].checks[key] = val;
    localStorage.setItem('med_v10_db', JSON.stringify(db));
    renderList();
}

function saveNote() {
    const date = picker.value, text = document.getElementById('note-input').value;
    let db = JSON.parse(localStorage.getItem('med_v10_db') || '{}');
    if (!db[date]) db[date] = { checks: {}, note: "" };
    db[date].note = text;
    localStorage.setItem('med_v10_db', JSON.stringify(db));
}

function goToday() { picker.value = getTodayStr(); renderList(); }
function resetDay() { if(confirm("重置记录？")){ let db=JSON.parse(localStorage.getItem('med_v10_db')||'{}'); delete db[picker.value]; localStorage.setItem('med_v10_db',JSON.stringify(db)); renderList(); }}
function exportJSON() {
    const blob = new Blob([localStorage.getItem('med_v10_db')], {type: 'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `med_records.json`; a.click();
}

// 【V12 强化手势引擎】
let tStartX = 0, tStartY = 0;
document.addEventListener('touchstart', e => {
    if (e.target.tagName.toLowerCase() === 'textarea' || e.target.tagName.toLowerCase() === 'input') return;
    tStartX = e.changedTouches[0].clientX;
    tStartY = e.changedTouches[0].clientY;
}, {passive: true});

document.addEventListener('touchend', e => {
    if (e.target.tagName.toLowerCase() === 'textarea' || e.target.tagName.toLowerCase() === 'input') return;
    const tEndX = e.changedTouches[0].clientX;
    const tEndY = e.changedTouches[0].clientY;
    
    const dx = tEndX - tStartX;
    const dy = tEndY - tStartY;
    
    // 只有当水平位移大于 80px 且明显超过垂直位移时才触发
    if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy)) {
        let curDate = new Date(picker.value);
        curDate.setDate(curDate.getDate() + (dx > 0 ? -1 : 1));
        picker.value = curDate.toLocaleDateString('en-CA');
        renderList();
    }
}, {passive: true});

document.addEventListener("visibilitychange", () => { if (!document.hidden) { window.lastMin = -1; tick(); } });
setInterval(tick, 1000);
tick();

// PWA 更新通知
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(reg => {
        reg.addEventListener('updatefound', () => {
            const nw = reg.installing;
            nw.addEventListener('statechange', () => {
                if (nw.state === 'installed' && navigator.serviceWorker.controller) {
                    if(confirm("检测到新版本 V12，是否刷新启用滑动功能？")) location.reload();
                }
            });
        });
    });
}
</script>
</body>
</html>
